
╔═══════════════════════════════════════════════════════════════════════════════╗
║                   AI RERANKING SYSTEM - VISUAL FLOW DIAGRAM                   ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│  USER QUERY: "environmental compliance services"                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
╔═════════════════════════════════════════════════════════════════════════════╗
║                         STAGE 1: TF-IDF RETRIEVAL                           ║
║                         (simple_hybrid_search.py)                           ║
╚═════════════════════════════════════════════════════════════════════════════╝
                                     │
                    ┌────────────────┴────────────────┐
                    │  Calculate query TF-IDF vector  │
                    └────────────────┬────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Compute cosine similarity      │
                    │  with all 2,892 documents       │
                    └────────────────┬────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Get top 30 candidates          │
                    │  (3× the limit of 10)           │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  TOP 30 RESULTS (TF-IDF Scores):                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  1. "Compliance Services Overview" .................... TF-IDF: 0.92        │
│  2. "Environmental Regulations Guide" ................. TF-IDF: 0.88        │
│  3. "Regulatory Compliance Consulting" ................ TF-IDF: 0.85        │
│  4. "Environmental Impact Assessment" ................. TF-IDF: 0.82        │
│  5. "Compliance Training Programs" .................... TF-IDF: 0.78        │
│  ...                                                                         │
│  30. "General Engineering Services" ................... TF-IDF: 0.12        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Take top 20 for AI reranking   │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
╔═════════════════════════════════════════════════════════════════════════════╗
║                        STAGE 2: AI RERANKING                                ║
║                        (cerebras_llm.py)                                    ║
╚═════════════════════════════════════════════════════════════════════════════╝
                                     │
                    ┌────────────────┴────────────────┐
                    │  Format results for LLM         │
                    │  Build scoring prompt           │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  LLM PROMPT (sent to Cerebras):                                             │
│  ───────────────────────────────────────────────────────────────────────── │
│                                                                              │
│  System: "You are an expert search relevance analyzer..."                  │
│                                                                              │
│  User: "Analyze these search results for: 'environmental compliance         │
│         services'"                                                          │
│                                                                              │
│  Result 1 (ID: 123):                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  📌 Title: Compliance Services Overview                                     │
│  📝 Excerpt: Comprehensive environmental compliance services...             │
│  ⭐ TF-IDF: 0.92                                                            │
│                                                                              │
│  Result 2 (ID: 456):                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  📌 Title: Environmental Regulations Guide                                  │
│  📝 Excerpt: Detailed guide to environmental regulations...                 │
│  ⭐ TF-IDF: 0.88                                                            │
│                                                                              │
│  ... (20 results total)                                                     │
│                                                                              │
│  📊 SCORING CRITERIA (0-100):                                               │
│  • Semantic Relevance (40 pts)                                              │
│  • User Intent (30 pts)                                                     │
│  • Content Quality (20 pts)                                                 │
│  • Specificity (10 pts)                                                     │
│                                                                              │
│  Return JSON: [{"id": "123", "ai_score": 95, "reason": "..."}, ...]        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Call Cerebras API              │
                    │  Model: llama-3.3-70b           │
                    │  Temperature: 0.1               │
                    │  Max Tokens: 2000               │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  LLM RESPONSE (AI Scores):                                                  │
│  ───────────────────────────────────────────────────────────────────────── │
│  [                                                                           │
│    {                                                                         │
│      "id": "456",                                                           │
│      "ai_score": 96,                                                        │
│      "reason": "Comprehensive regulatory guide, directly addresses          │
│                 compliance requirements"                                     │
│    },                                                                        │
│    {                                                                         │
│      "id": "123",                                                           │
│      "ai_score": 88,                                                        │
│      "reason": "Service-focused but highly relevant to compliance needs"   │
│    },                                                                        │
│    {                                                                         │
│      "id": "789",                                                           │
│      "ai_score": 82,                                                        │
│      "reason": "Related to environmental impact, less direct on services"  │
│    },                                                                        │
│    ...                                                                       │
│  ]                                                                           │
│                                                                              │
│  Response Time: 1.42s                                                       │
│  Tokens Used: 1,680                                                         │
│  Cost: $0.000168                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Parse JSON response            │
                    │  Normalize AI scores (÷100)     │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
╔═════════════════════════════════════════════════════════════════════════════╗
║                      HYBRID SCORE CALCULATION                               ║
╚═════════════════════════════════════════════════════════════════════════════╝
                                     │
                ┌────────────────────┴────────────────────┐
                │  For each result:                       │
                │                                          │
                │  AI Weight = 0.7 (70%)                  │
                │  TF-IDF Weight = 0.3 (30%)              │
                │                                          │
                │  Hybrid = (TF-IDF × 0.3) + (AI × 0.7)   │
                └────────────────────┬────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  HYBRID SCORE EXAMPLES:                                                     │
│  ───────────────────────────────────────────────────────────────────────── │
│                                                                              │
│  Result ID: 456                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ TF-IDF Score:  0.88                                                  │  │
│  │ AI Score:      0.96                                                  │  │
│  │                                                                       │  │
│  │ Calculation:                                                         │  │
│  │   Hybrid = (0.88 × 0.3) + (0.96 × 0.7)                              │  │
│  │          = 0.264 + 0.672                                             │  │
│  │          = 0.936 ✨ (NEW RANK: #1)                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Result ID: 123                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ TF-IDF Score:  0.92                                                  │  │
│  │ AI Score:      0.88                                                  │  │
│  │                                                                       │  │
│  │ Calculation:                                                         │  │
│  │   Hybrid = (0.92 × 0.3) + (0.88 × 0.7)                              │  │
│  │          = 0.276 + 0.616                                             │  │
│  │          = 0.892 (NEW RANK: #2)                                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Result ID: 789                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ TF-IDF Score:  0.82                                                  │  │
│  │ AI Score:      0.82                                                  │  │
│  │                                                                       │  │
│  │ Calculation:                                                         │  │
│  │   Hybrid = (0.82 × 0.3) + (0.82 × 0.7)                              │  │
│  │          = 0.246 + 0.574                                             │  │
│  │          = 0.820 (NEW RANK: #3)                                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Sort by hybrid score (desc)    │
                    └────────────────┬────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  FINAL RERANKED RESULTS (Top 10):                                           │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  🥇 #1: "Environmental Regulations Guide"                                   │
│      📊 Hybrid: 0.936 | 🔤 TF-IDF: 0.88 | 🤖 AI: 0.96                      │
│      💡 AI Reason: "Comprehensive regulatory guide, directly addresses      │
│                     compliance requirements"                                 │
│                                                                              │
│  🥈 #2: "Compliance Services Overview"                                      │
│      📊 Hybrid: 0.892 | 🔤 TF-IDF: 0.92 | 🤖 AI: 0.88                      │
│      💡 AI Reason: "Service-focused but highly relevant to compliance"      │
│                                                                              │
│  🥉 #3: "Environmental Impact Assessment"                                   │
│      📊 Hybrid: 0.820 | 🔤 TF-IDF: 0.82 | 🤖 AI: 0.82                      │
│      💡 AI Reason: "Related to environmental impact, balanced relevance"    │
│                                                                              │
│  4️⃣  #4: "Regulatory Compliance Consulting"                                 │
│      📊 Hybrid: 0.798 | 🔤 TF-IDF: 0.85 | 🤖 AI: 0.77                      │
│                                                                              │
│  5️⃣  #5: "Compliance Training Programs"                                     │
│      📊 Hybrid: 0.771 | 🔤 TF-IDF: 0.78 | 🤖 AI: 0.77                      │
│                                                                              │
│  ... (results 6-10)                                                         │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│  📈 Statistics:                                                              │
│     • AI Reranking: ✅ Used                                                 │
│     • Response Time: 1.42s                                                  │
│     • Tokens Used: 1,680                                                    │
│     • Cost: $0.000168                                                       │
│     • Results Reranked: 20                                                  │
│     • AI Weight: 70%                                                        │
│     • TF-IDF Weight: 30%                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RETURNED TO USER (via WordPress Plugin)                                    │
└─────────────────────────────────────────────────────────────────────────────┘

╔═════════════════════════════════════════════════════════════════════════════╗
║                           KEY IMPROVEMENTS                                  ║
╚═════════════════════════════════════════════════════════════════════════════╝

  BEFORE AI RERANKING (TF-IDF only):          AFTER AI RERANKING:
  ────────────────────────────────────         ─────────────────────────────
  1. Compliance Services (0.92) ──┐            1. Environmental Regs (0.936) ✨
  2. Environmental Regs (0.88)    │            2. Compliance Services (0.892)
  3. Regulatory Consult (0.85)    │            3. Impact Assessment (0.820)
  4. Impact Assessment (0.82)     │            4. Regulatory Consult (0.798)
  5. Training Programs (0.78)     │            5. Training Programs (0.771)
                                  │
  Based on keyword matching only  └─> AI understands SEMANTIC MEANING
                                      and USER INTENT, reorders for
                                      better relevance! 🎯

╔═════════════════════════════════════════════════════════════════════════════╗
║                          CONFIGURATION OPTIONS                              ║
╚═════════════════════════════════════════════════════════════════════════════╝

  📍 WordPress Admin → Settings → Hybrid Search

  ┌───────────────────────────────────────────────────────────────────────┐
  │  ☑ Enable AI Reranking                                                │
  │                                                                         │
  │  AI Weight (how much to trust AI vs TF-IDF):                          │
  │  ├─────────────────┬─────────────────┬─────────────────┐             │
  │  0%              50%               70% ✓             100%             │
  │  (All TF-IDF)  (Balanced)     (Default)        (All AI)              │
  │                                                                         │
  │  Custom AI Instructions (optional):                                    │
  │  ┌─────────────────────────────────────────────────────────────────┐ │
  │  │ Prioritize:                                                      │ │
  │  │ - Recent content (within 6 months)                              │ │
  │  │ - Results with case studies or examples                         │ │
  │  │ - Technical depth for complex queries                           │ │
  │  └─────────────────────────────────────────────────────────────────┘ │
  │                                                                         │
  │  [Save Settings]  [Test API]                                          │
  └───────────────────────────────────────────────────────────────────────┘

╔═════════════════════════════════════════════════════════════════════════════╗
║                            COST BREAKDOWN                                   ║
╚═════════════════════════════════════════════════════════════════════════════╝

  Per Search:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Tokens:        1,500 - 2,000 tokens
  Cost/Search:   $0.00015 - $0.0002  (less than $0.0002!)
  Response Time: 1-2 seconds

  Monthly (10,000 searches):
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Total Cost:    ~$1.50 - $2.00/month
  
  💡 Extremely cost-effective for the value provided!

═══════════════════════════════════════════════════════════════════════════════


